# LittleVec

[English README](readme.md)

**LittleVec** — легковесная и эффективная по памяти векторная база данных.  
Позволяет быстро искать ближайшие векторы и хранить дополнительную информацию (payload) для каждого объекта.

Работает как плагин для [RocksServer](https://github.com/valmat/RocksServer).  
**Установите плагин, запустите RocksServer — и начинайте пользоваться!**

---

## Преимущества

- Минималистичный API: только необходимые функции, ничего лишнего
- Эффективность по памяти и скорости
- Простая интеграция
- Поддержка нескольких независимых векторных баз
- Работает даже на самых маломощных серверах и VPS

---

## Быстрый старт

1. Установите [RocksServer](https://github.com/valmat/RocksServer) и плагин LittleVec.
2. Запустите RocksServer.
3. Используйте HTTP API LittleVec для работы с векторами и поиска.

### Установка плагина *LittleVec* для RocksServer

Для установки плагина необходимо скомпилировать проект:

```bash
cd src
make -j
```

В результате в каталоге `src` появится файл `little_vec.so`. Его нужно поместить в каталог плагинов RocksServer.
Каталог плагинов определяется в файле [config.ini](https://github.com/valmat/RocksServer/blob/master/src/config.ini) параметром `extdir` (по умолчанию: `/usr/lib/rocksserver/plugins`).

Вы также можете задать собственные настройки LittleVec, добавив их в ini-файл RocksServer, который располагается в каталоге `/etc/rocksserver`. Описание всех возможных настроек приведено в соответствующем [ini-файле](https://github.com/valmat/little-vec/blob/dev/config.ini).

После этого необходимо перезапустить RocksServer:

```bash
sudo /etc/init.d/rocksserver restart
```

Теперь база данных готова к использованию.  
По умолчанию LittleVec работает на 127.0.0.1:5577, но вы можете изменить этот и другие параметры, указав их в ini-файле.

### Установка через DEB-пакет

Для упрощения установки можно собрать DEB-пакет.  
Для этого перейдите в каталог `build_deb` и запустите скрипт сборки `build.sh`:

```bash
cd build_deb
./build.sh
```

В результате появится пакет `littlevec_<version>_amd64.deb`, который можно установить с помощью команды:

```bash
sudo dpkg -i littlevec_<version>_amd64.deb
```

Перед установкой littlevec необходимо установить [последний релиз RocksServer](https://github.com/valmat/RocksServer/releases).

### Запуск через Docker

[Образ на DockerHub](https://hub.docker.com/r/valmatdocker/littlevec)

Запустить контейнер можно командой:

```bash
docker pull valmatdocker/littlevec
docker run -d -p 5577:5577 --name littlevec valmatdocker/littlevec
```

- Контейнер запустится в фоновом режиме.
- RocksServer с плагином LittleVec будет доступен на порту `5577`.

Чтобы остановить контейнер, выполните команду `docker stop littlevec`, а чтобы удалить его — `docker rm littlevec`.

### Использование Docker Compose

Для удобства можно использовать [docker-compose](https://docs.docker.com/compose/):

Создайте файл `docker-compose.yml` со следующим содержимым:

```yaml
version: '3.8'
services:
  littlevec:
    image: valmatdocker/littlevec
    container_name: littlevec
    ports:
      - "5577:5577"
```

Запуск:

```bash
docker-compose up -d
```

Остановка:

```bash
docker-compose down -v
```

---

# API

## Работа с базами данных

> Все операции с базами осуществляются через эндпоинты `/vecdb/...`

Во всех эндпоинтах этого раздела при успешном выполнении возвращается код ответа 200 и тело:
```json
{"success": true}
```

### Создание базы данных

**POST** `/vecdb/create`

```json
{
    "name": "<имя_БД (строка)>",
    "dim": <размерность_векторов (int)>,
    "dist": "<метрика расстояния (опционально, см. ниже)>"
}
```

- **name** (строка, обязательно) — уникальное имя базы данных
- **dim** (int, обязательно) — размерность векторов
- **dist** (строка, опционально) — метрика: `"qcos"` (по умолчанию), `"cos"`, `"dot_prod"`, `"l1"`, `"l2"`

**Пример запроса**:
```json
{
    "name": "my_vectors",
    "dim": 128,
    "dist": "cos"
}
```

#### Возможные ошибки:
- 400: Некорректные параметры (`{"error": "Description of problem"}`)
- 409: База с таким именем уже существует (`{"error": "Database already exists"}`)

---

### Удаление базы данных

**POST** `/vecdb/delete`

```json
{
    "name": "<имя_БД>"
}
```

---

### Обновление параметров базы данных

**POST** `/vecdb/update`

```json
{
    "name": "<имя_БД>",
    "dist": "<новая метрика расстояния>"
}
```
> *Изменяется только метрика расстояния.*

---

## Операции с векторами

> Все операции с векторами осуществляются через эндпоинты `/vectors/...`  
> В каждом запросе обязательно указывайте поле `db_name` — имя рабочей базы данных.

---

### Добавление / обновление векторов

**POST** `/vectors/set`

```json
{
    "db_name": "my_vectors",
    "data": [
        {
            "id": "123",
            "vector": [0.1, 0.2, 0.3, ...],
            "payload": <произвольный JSON, опционально>
        },
        ...
    ]
}
```
- **id** (строка) — уникальный идентификатор вектора
- **vector** (массив float) — длина должна соответствовать dim
- **payload** — произвольный сериализуемый объект (опционально)

В случае успеха возвращается код ответа 200 и тело:
```json
{"success": true}
```

---

### Удаление векторов

**POST** `/vectors/delete`

```json
{
    "db_name": "my_vectors",
    "data": [
        { "id": "123" },
        ...
    ]
}
```

В случае успеха возвращается код ответа 200 и тело:
```json
{"success": true}
```

---

## Прямое получение данных из БД

### Получение объектов по их id
**POST** `/vectors/get/data`

Пример запроса:
```json
{
    "db_name": "my_vectors",
    "ids": ["id1", "id2", ...]
}
```

Ответ:
```json
{
    "data": [
        { "id": "id1", "payload": ... },
        ...
    ]
}
```

### Получение расстояний между векторами и объектами по ID

**POST** `/vectors/get/distances`

```json
{
    "db_name": "my_vectors",
    "vectors": [
        {
            "vector": [0.1, 0.2, 0.3, ...],
            "extra": <any JSON, optional>
        },
        ...
    ],    
    "ids": ["id1", "id2"],
    "dist": "<metric, optional>"
}
```

Ответ:
```json
{
    "data": [
        {
            "id": "id1",
            "payload": ...,
            "distances": [
                {"distance": 0.12, "extra": ...},
                ...
            ]
        },{
            "id": "id2",
            "payload": ...,
            "distances": [
                {"distance": 0.34, "extra": ...},
                ...
            ]            
        }
    ]
}
```

---

## Поиск ближайших векторов

### Поиск по одному вектору

**POST** `/vectors/get/nearest`

```json
{
    "db_name": "my_vectors",
    "vector": [0.1, 0.2, 0.3, ...],
    "top_k": <количество ближайших векторов в ответе, опционально>,
    "dist": "<метрика, опционально (переопределяет dist из базы)>"
}
```

**Ответ:**
```json
{
    "data": [
        { "id": "123", "distance": 0.123, "payload": ... },
        ...
    ]
}
```

---

### Batch-поиск по массиву векторов

**POST** `/vectors/get/batch/nearest`

```json
{
    "db_name": "my_vectors",
    "vectors": [
        {
            "vector": [0.1, 0.2, 0.3, ...],
            "extra": <любой JSON, опционально>
        },
        ...
    ],
    "top_k": <количество ближайших векторов в ответе, опционально>,
    "dist": "<метрика, опционально>"
}
```

**Ответ:**
```json
{
    "results": [
        {
            "data": [
                { "id": "123", "distance": 0.123, "payload": ... },
                ...
            ],
            "extra": <JSON, если он был отправлен в запросе>
        },
        ...
    ]
}
```

---

# Формат ошибок

Все ошибки возвращаются с соответствующим HTTP-статусом (400, 404, 409, 500 и др.).  
В теле ответа всегда присутствует:
```json
{
  "error": "Описание ошибки"
}
```

**Типичные ошибки:**
- 400: Некорректный запрос / ошибка валидации (например, размерность вектора не совпадает)
- 404: База или запись не найдена
- 409: Попытка создать уже существующую базу или запись
- 500: Внутренняя ошибка сервера

---

# Особенности

- В основе лежит [RocksDB](https://rocksdb.org/) — очень [эффективная БД](https://github.com/facebook/rocksdb) с поддержкой итераторов и высокой производительностью на SSD.

- Главная задача *LittleVec* — быть эффективной по памяти векторной БД. Низкое потребление ОЗУ: **15–20 Мб** даже при хранении миллионов векторов и гигабайтах данных.

- На миллионе векторов размерностью 50 запрос выполняется примерно за 60 мс.

- Нет шардинга и репликации: решение рассчитано на запуск в рамках одного сервера, но в этих условиях работает эффективно.

## Дополнительно

- В каждом запросе явно указывается имя базы данных, что позволяет использовать несколько баз одновременно.

- Лимит на размер payload определяется возможностями RocksDB и параметром `max_body_size` в RocksServer.
  
- В каждом поисковом запросе можно указать функцию расстояния вручную. Также метрику по умолчанию можно изменить, обновив параметры базы данных.

---

## License

LittleVec распространяется под лицензией [MIT License](LICENSE).
